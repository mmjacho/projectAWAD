<h2 mat-dialog-title>Nueva Venta / Pedido</h2>

    <mat-dialog-content class="pb-3">
      <!-- SECCIÓN 1: CABECERA (CLIENTE Y FECHA) -->
      <form [formGroup]="headerForm" class="d-flex gap-3 mb-3">
         <mat-form-field appearance="outline" class="flex-grow-1">
            <mat-label>Cliente</mat-label>
            <mat-select formControlName="clienteId">
               @for (c of clienteService.clientes(); track c.id) {
                 <mat-option [value]="c.id">{{ c.razonSocial }} ({{ c.ruc }})</mat-option>
               }
            </mat-select>
            <mat-icon matSuffix>person</mat-icon>
         </mat-form-field>

         <mat-form-field appearance="outline" style="width: 180px;">
            <mat-label>Fecha</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="fecha">
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
         </mat-form-field>
      </form>

      <mat-divider></mat-divider>

      <!-- SECCIÓN 2: AGREGAR PRODUCTOS -->
      <h3 class="mt-3 mb-2 text-secondary" style="font-size: 1rem;">Agregar Productos</h3>
      <form [formGroup]="itemForm" class="d-flex gap-2 align-items-start bg-light p-2 rounded">
         
         <!-- Lote Selector -->
         <mat-form-field appearance="outline" class="flex-grow-1">
            <mat-label>Lote Disponible</mat-label>
            <mat-select formControlName="loteId">
               @for (l of lotesDisponibles(); track l.id) {
                 <mat-option [value]="l.id">
                    {{ l.codigo }} - {{ l.calidad }} (Stock: {{ l.stockActual }} {{ l.unidad }})
                 </mat-option>
               }
            </mat-select>
         </mat-form-field>

         <!-- Cantidad -->
         <mat-form-field appearance="outline" style="width: 120px;">
            <mat-label>Cant.</mat-label>
            <input matInput type="number" formControlName="cantidad" min="1">
         </mat-form-field>

         <!-- Precio -->
         <mat-form-field appearance="outline" style="width: 120px;">
            <mat-label>Precio $</mat-label>
            <input matInput type="number" formControlName="precio" min="0">
         </mat-form-field>

         <button mat-mini-fab color="primary" class="mt-1" (click)="agregarItem()" [disabled]="itemForm.invalid">
            <mat-icon>add</mat-icon>
         </button>
      </form>

      <!-- SECCIÓN 3: TABLA DE DETALLES -->
      <div class="table-container mt-3 mat-elevation-z1">
        <table mat-table [dataSource]="items()">
           
           <ng-container matColumnDef="producto">
              <th mat-header-cell *matHeaderCellDef> Producto </th>
              <td mat-cell *matCellDef="let item"> {{ item.codigoLote }} </td>
           </ng-container>

           <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef> Cant. </th>
              <td mat-cell *matCellDef="let item"> {{ item.cantidad }} </td>
           </ng-container>

           <ng-container matColumnDef="precio">
              <th mat-header-cell *matHeaderCellDef> P. Unit </th>
              <td mat-cell *matCellDef="let item"> $ {{ item.precioUnitario }} </td>
           </ng-container>

           <ng-container matColumnDef="subtotal">
              <th mat-header-cell *matHeaderCellDef> Subtotal </th>
              <td mat-cell *matCellDef="let item" class="fw-bold"> $ {{ item.subtotal }} </td>
           </ng-container>

           <ng-container matColumnDef="accion">
              <th mat-header-cell *matHeaderCellDef> </th>
              <td mat-cell *matCellDef="let item; let i = index"> 
                 <button mat-icon-button color="warn" (click)="removerItem(i)">
                    <mat-icon>remove_circle_outline</mat-icon>
                 </button>
              </td>
           </ng-container>

           <tr mat-header-row *matHeaderRowDef="['producto', 'cantidad', 'precio', 'subtotal', 'accion']"></tr>
           <tr mat-row *matRowDef="let row; columns: ['producto', 'cantidad', 'precio', 'subtotal', 'accion']"></tr>
        </table>

        @if (items().length === 0) {
            <div class="p-3 text-center text-muted fst-italic">
                No hay items en el pedido.
            </div>
        }
      </div>

      <!-- TOTALES -->
      <div class="d-flex justify-content-end align-items-center mt-3 gap-3">
         <span class="text-secondary">Total a Pagar:</span>
         <span class="display-6 fw-bold text-primary">$ {{ totalPedido() }}</span>
      </div>

    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button (click)="dialogRef.close()">Cancelar</button>
      <button mat-flat-button color="primary" (click)="guardarPedido()" [disabled]="headerForm.invalid || items().length === 0">
        <mat-icon class="me-2">save</mat-icon> Finalizar Venta
      </button>
    </mat-dialog-actions>