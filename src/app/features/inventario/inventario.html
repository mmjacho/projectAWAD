<div class="container-fluid p-4">
      
      <!-- HEADER CON KPIs (INDICADORES) -->
      <div class="row mb-4">
        <div class="col-md-4">
           <mat-card class="kpi-card bg-primary-soft">
              <mat-card-content>
                  <div class="kpi-title">Total en Bodega</div>
                  <div class="kpi-value">{{ inventarioService.totalStock() | number:'1.0-2' }} <small>qq</small></div>
                  <mat-icon class="kpi-icon">warehouse</mat-icon>
              </mat-card-content>
           </mat-card>
        </div>
        <div class="col-md-4">
           <mat-card class="kpi-card">
              <mat-card-content>
                  <div class="kpi-title">Lotes Activos</div>
                  <div class="kpi-value">{{ lotesActivosCount() }}</div>
                  <mat-icon class="kpi-icon text-muted">layers</mat-icon>
              </mat-card-content>
           </mat-card>
        </div>
      </div>

      <!-- PESTAÑAS DE GESTIÓN -->
      <mat-tab-group animationDuration="0ms" mat-stretch-tabs="false" mat-align-tabs="start" class="mat-elevation-z4 bg-white rounded">
        
        <!-- TAB 1: BODEGA (LOTES) -->
        <mat-tab label="Bodega de Lotes">
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="m-0 text-secondary">Listado de Lotes</h3>
                    <button mat-flat-button color="primary" (click)="openCosecha()">
                        <mat-icon>add</mat-icon> Registrar Cosecha
                    </button>
                </div>

                <table mat-table [dataSource]="inventarioService.lotes()" class="w-100">
                    
                    <!-- Código -->
                    <ng-container matColumnDef="codigo">
                        <th mat-header-cell *matHeaderCellDef> Código </th>
                        <td mat-cell *matCellDef="let l" class="fw-bold text-primary"> {{l.codigo}} </td>
                    </ng-container>

                    <!-- Origen -->
                    <ng-container matColumnDef="origen">
                        <th mat-header-cell *matHeaderCellDef> Origen (Parcela) </th>
                        <td mat-cell *matCellDef="let l"> {{ getNombreParcela(l.parcelaId) }} </td>
                    </ng-container>

                    <!-- Fecha -->
                    <ng-container matColumnDef="fecha">
                        <th mat-header-cell *matHeaderCellDef> Cosecha </th>
                        <td mat-cell *matCellDef="let l"> {{l.fechaCosecha | date:'dd/MM/yy'}} </td>
                    </ng-container>

                    <!-- Calidad -->
                    <ng-container matColumnDef="calidad">
                        <th mat-header-cell *matHeaderCellDef> Calidad </th>
                        <td mat-cell *matCellDef="let l"> 
                            <span class="badge-outline">{{l.calidad}}</span>
                        </td>
                    </ng-container>

                    <!-- Stock (Barra visual) -->
                    <ng-container matColumnDef="stock">
                        <th mat-header-cell *matHeaderCellDef> Stock Actual </th>
                        <td mat-cell *matCellDef="let l" style="width: 200px;"> 
                            <div class="d-flex flex-column">
                                <span class="fw-bold">{{l.stockActual}} / {{l.cantidadInicial}} {{l.unidad}}</span>
                                <mat-progress-bar mode="determinate" 
                                    [value]="(l.stockActual / l.cantidadInicial) * 100"
                                    [color]="l.stockActual < 10 ? 'warn' : 'primary'"
                                    class="mt-1">
                                </mat-progress-bar>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Estado -->
                    <ng-container matColumnDef="estado">
                        <th mat-header-cell *matHeaderCellDef> Estado </th>
                        <td mat-cell *matCellDef="let l"> 
                            <mat-chip-set>
                                <mat-chip [color]="l.estado === 'DISPONIBLE' ? 'primary' : 'warn'" selected>
                                    {{l.estado}}
                                </mat-chip>
                            </mat-chip-set>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="colsLotes"></tr>
                    <tr mat-row *matRowDef="let row; columns: colsLotes;"></tr>
                </table>
            </div>
        </mat-tab>

        <!-- TAB 2: KARDEX (HISTORIAL) -->
        <mat-tab label="Movimientos (Kardex)">
            <div class="p-3">
                <h3 class="text-secondary mb-3">Historial de Transacciones</h3>
                <table mat-table [dataSource]="inventarioService.movimientos()" class="w-100 table-striped">
                    
                    <ng-container matColumnDef="fecha">
                        <th mat-header-cell *matHeaderCellDef> Fecha </th>
                        <td mat-cell *matCellDef="let m"> {{m.fecha | date:'dd/MM/yyyy HH:mm'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="tipo">
                        <th mat-header-cell *matHeaderCellDef> Tipo </th>
                        <td mat-cell *matCellDef="let m"> 
                            <span [class.text-success]="m.esEntrada" [class.text-danger]="!m.esEntrada" class="fw-bold">
                                {{m.tipo}}
                            </span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="lote">
                        <th mat-header-cell *matHeaderCellDef> Ref. Lote </th>
                        <td mat-cell *matCellDef="let m"> {{ getCodigoLote(m.loteId) }} </td>
                    </ng-container>

                    <ng-container matColumnDef="cantidad">
                        <th mat-header-cell *matHeaderCellDef> Cantidad </th>
                        <td mat-cell *matCellDef="let m" class="fw-bold"> 
                            {{ m.esEntrada ? '+' : '-' }}{{m.cantidad}} 
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="motivo">
                        <th mat-header-cell *matHeaderCellDef> Motivo / Detalle </th>
                        <td mat-cell *matCellDef="let m"> {{m.motivo}} </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="colsMovs"></tr>
                    <tr mat-row *matRowDef="let row; columns: colsMovs;"></tr>
                </table>
            </div>
        </mat-tab>

      </mat-tab-group>
    </div>